<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CHASTE DRAGON - Event Receh</title>

<style>
body{
  margin:0;
  background:black;
  font-family:Poppins, sans-serif;
  color:white;
  text-align:center;
  padding:30px;
}

h1{
  color:gold;
  text-shadow:0 0 15px gold;
}

.status{
  font-weight:bold;
  padding:10px;
  border-radius:10px;
  margin-bottom:20px;
}

.aktif{
  background:green;
}

.tutup{
  background:red;
}

.card{
  background:#111;
  border:2px solid gold;
  border-radius:20px;
  padding:30px;
  max-width:900px;
  margin:30px auto;
  box-shadow:0 0 30px gold;
}

.countdown{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:20px;
  flex-wrap:wrap;
}

.box{
  background:black;
  border:2px solid gold;
  padding:20px;
  border-radius:15px;
  min-width:90px;
}

.number{
  font-size:24px;
  font-weight:bold;
  color:gold;
}

input{
  padding:10px;
  border-radius:8px;
  border:2px solid gold;
  background:black;
  color:white;
  width:180px;
  margin:5px;
}

button{
  padding:8px 15px;
  border:none;
  border-radius:8px;
  background:gold;
  color:black;
  font-weight:bold;
  cursor:pointer;
  margin:5px;
}

button:disabled{
  background:gray;
  cursor:not-allowed;
}

.member{
  padding:8px;
  border-bottom:1px solid gold;
}
</style>
</head>

<body>

<h1>üêâ EVENT RECEH</h1>
<h2>CHASTE DRAGON LEADER</h2>

<div id="eventStatus" class="status aktif">EVENT AKTIF</div>

<div class="card">

<h3>üî• Countdown Menuju Event üî•</h3>

<div class="countdown">
  <div class="box"><div class="number" id="hari">0</div>Hari</div>
  <div class="box"><div class="number" id="jam">0</div>Jam</div>
  <div class="box"><div class="number" id="menit">0</div>Menit</div>
  <div class="box"><div class="number" id="detik">0</div>Detik</div>
</div>

<hr style="border:1px solid gold;margin:30px 0;">

<h3>Daftar Peserta</h3>

<input type="text" id="nameInput" placeholder="Nama">
<input type="number" id="waInput" placeholder="Nomor WA (08xxxx)">
<br>
<button id="joinBtn" onclick="joinEvent()">JOIN</button>

<hr style="border:1px solid gold;margin:30px 0;">

<h3>Total Peserta: <span id="totalPeserta">0</span></h3>
<div id="memberList"></div>

<br>
<button onclick="pickWinner()">üé≤ Random Pick Winner</button>
<button onclick="exportExcel()">üì• Export Excel</button>

<h2 id="winner" style="color:gold;margin-top:20px;"></h2>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAx63q_PnqWj34c5zxH9aZcwUjKHWAsaYA",
    authDomain: "chastedragon.firebaseapp.com",
    projectId: "chastedragon",
    storageBucket: "chastedragon.firebasestorage.app",
    messagingSenderId: "926861094687",
    appId: "1:926861094687:web:43b817d47f604eb9e0ca2a"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

const ADMIN_PASSWORD = "CHASTE2026";

/* ================= TANGGAL EVENT ================= */
const eventTanggal = "February 28, 2026 21:00:00";
let eventClosed = false;

/* ================= COUNTDOWN ================= */

function updateCountdown(){

  const now = new Date();
  let eventDate = new Date(eventTanggal);

  if(now.getTime() > eventDate.getTime()){
    eventClosed = true;
  }

  const jarak = eventDate.getTime() - now.getTime();

  if(jarak <= 0){
    closeEvent();
    return;
  }

  document.getElementById("hari").innerText =
    Math.floor(jarak/(1000*60*60*24));
  document.getElementById("jam").innerText =
    Math.floor((jarak%(1000*60*60*24))/(1000*60*60));
  document.getElementById("menit").innerText =
    Math.floor((jarak%(1000*60*60))/(1000*60));
  document.getElementById("detik").innerText =
    Math.floor((jarak%(1000*60))/1000);
}

function closeEvent(){
  document.getElementById("eventStatus").innerText = "EVENT DITUTUP";
  document.getElementById("eventStatus").classList.remove("aktif");
  document.getElementById("eventStatus").classList.add("tutup");

  document.getElementById("joinBtn").disabled = true;
}

setInterval(updateCountdown,1000);
updateCountdown();

/* ================= JOIN EVENT ================= */

window.joinEvent = function(){

  if(eventClosed){
    alert("Event sudah ditutup!");
    return;
  }

  const name = document.getElementById("nameInput").value.trim();
  const wa = document.getElementById("waInput").value.trim();

  if(name === "" || wa === ""){
    alert("Nama & Nomor WA wajib diisi!");
    return;
  }

  const regex = /^08[0-9]{8,13}$/;
  if(!regex.test(wa)){
    alert("Format nomor WA tidak valid!");
    return;
  }

  push(ref(database, "chasteEventParticipants"), {
    nama: name,
    wa: wa,
    waktu: new Date().toLocaleString()
  });

  document.getElementById("nameInput").value = "";
  document.getElementById("waInput").value = "";
}

/* ================= REALTIME LIST ================= */

let participants = {};

onValue(ref(database, "chasteEventParticipants"), (snapshot) => {

  const data = snapshot.val();
  const list = document.getElementById("memberList");
  const total = document.getElementById("totalPeserta");

  list.innerHTML = "";
  participants = {};

  if(!data){
    total.innerText = 0;
    return;
  }

  let index = 1;

  for(let key in data){
    participants[key] = data[key];

    list.innerHTML += `
      <div class="member">
        ${index}. ${data[key].nama} - ${data[key].wa}
        <button onclick="hapusPeserta('${key}')">‚ùå</button>
      </div>
    `;
    index++;
  }

  total.innerText = index - 1;
});

/* ================= HAPUS PESERTA ================= */

window.hapusPeserta = function(key){

  const pass = prompt("Masukkan Password Admin:");
  if(pass !== ADMIN_PASSWORD){
    alert("Password salah!");
    return;
  }

  remove(ref(database, "chasteEventParticipants/" + key));
}

/* ================= RANDOM PICKER ================= */

window.pickWinner = function(){

  const keys = Object.keys(participants);

  if(keys.length === 0){
    alert("Belum ada peserta!");
    return;
  }

  const randomKey = keys[Math.floor(Math.random()*keys.length)];
  const winner = participants[randomKey];

  document.getElementById("winner").innerText =
    "üèÜ Pemenang: " + winner.nama + " (" + winner.wa + ")";
}

/* ================= EXPORT CSV ================= */

window.exportExcel = function(){

  let csv = "No,Nama,Nomor WA\n";
  let index = 1;

  for(let key in participants){
    csv += index + "," + participants[key].nama + "," + participants[key].wa + "\n";
    index++;
  }

  const blob = new Blob([csv], {type: "text/csv"});
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Peserta_CHASTE_DRAGON.csv";
  a.click();
}

</script>

</body>
</html>